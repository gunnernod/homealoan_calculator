<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå Mitr (‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Mitr', sans-serif;
        }

        /* ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ */
        .app-container {
            width: 100%;
            /* [FIX] ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
            max-width: 420px;
            /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì */
            height: 90vh;
            max-height: 800px;
            overflow-y: auto;
            /* ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏ß */
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô scrollbar */
        .app-container::-webkit-scrollbar {
            display: none;
        }

        .app-container {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }

        .form-input {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Result Box */
        .ai-result-box {
            @apply mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg text-sm;
        }
    </style>
</head>

<body class="bg-white flex items-center justify-center min-h-screen">

    <!-- [STYLE] ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß, ‡∏ï‡∏±‡∏ß‡πÅ‡∏≠‡∏õ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô -->
    <div class="app-container bg-pink-100 rounded-2xl shadow-2xl p-6 flex flex-col">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-blue-800">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô/‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î</h1>
            <p class="text-sm text-gray-600">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ</p>
        </header>

        <!-- Form -->
        <main class="flex-grow">
            <div class="space-y-4">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô -->
                <div>
                    <label for="income" class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="income" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 35000">
                </div>
                <div>
                    <label for="expenses" class="form-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡∏†‡∏≤‡∏£‡∏∞‡∏ú‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                    <input type="number" id="expenses" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5000">
                </div>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ -->
                <div>
                    <label for="loanAmount" class="form-label">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="loanAmount" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2000000">
                </div>
                <div>
                    <label for="duration" class="form-label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡∏õ‡∏µ)</label>
                    <input type="number" id="duration" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 30">
                </div>
                <div>
                    <label for="bankRates" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3 ‡∏õ‡∏µ)</label>
                    <select id="bankRates" class="form-input">
                        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                    </select>
                </div>
            </div>

            <!-- Calculate Button -->
            <button id="calculateBtn"
                class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 mt-6">
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            </button>

            <!-- Error Message -->
            <p id="errorMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>

            <!-- Results Section -->
            <div id="results" class="mt-6 border-t border-gray-300 pt-4 hidden">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h2>
                <div class="space-y-2 p-4 bg-white rounded-lg shadow-inner">
                    <div class="flex justify-between">
                        <span class="text-gray-600">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):</span>
                        <span id="paymentResult" class="font-bold text-blue-700"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢):</span>
                        <span id="netIncomeResult" class="font-bold text-gray-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô:</span>
                        <span id="statusResult" class="font-bold px-2 py-0.5 rounded-full text-sm"></span>
                    </div>
                </div>

                <!-- AI Button -->
                <button id="aiBtn"
                    class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-purple-700 transition duration-300 mt-4 hidden">
                    ‚ú® ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
                </button>

                <!-- AI Loading -->
                <div id="aiLoading" class="mt-4 text-center text-purple-600 hidden">
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... üß†</p>
                </div>

                <!-- AI Result -->
                <div id="aiResult" class_name="ai-result-box hidden">
                    <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>

            </div>
        </main>
    </div>

    <script>
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á JavaScript ---

        // [FIX] 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Mock Data) ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
        const bankPromotions = [
            { name: "‡∏ò. ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.50%)", rate: 3.50 },
            { name: "‡∏ò. ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.25%)", rate: 3.25 },
            { name: "‡∏ò. ‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.40%)", rate: 3.40 },
            { name: "‡∏ò. ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.33%)", rate: 3.33 },
            { name: "‡∏ò. ‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.15%)", rate: 3.15 },
            { name: "‡∏ò. ‡∏ò‡∏≠‡∏™. (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.20%)", rate: 3.20 },
            { name: "‡∏ò. TTB (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 3.45%)", rate: 3.45 },
            { name: "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)", rate: -1 } // -1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏≠‡∏á
        ];

        // 2. DOM Elements
        const incomeInput = document.getElementById('income');
        const expensesInput = document.getElementById('expenses');
        const loanAmountInput = document.getElementById('loanAmount');
        const durationInput = document.getElementById('duration');
        const bankRatesSelect = document.getElementById('bankRates');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsDiv = document.getElementById('results');
        const paymentResult = document.getElementById('paymentResult');
        const netIncomeResult = document.getElementById('netIncomeResult');
        const statusResult = document.getElementById('statusResult');
        const errorMessage = document.getElementById('errorMessage');

        const aiBtn = document.getElementById('aiBtn');
        const aiLoading = document.getElementById('aiLoading');
        const aiResult = document.getElementById('aiResult');

        let lastCalculationData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

        // --- API Key (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• Flash) ---
        const apiKey = ""; // ‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡πà‡∏≤‡∏á

        // --- Functions ---

        /**
         * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
         */
        function populateBankRates() {
            bankPromotions.forEach(promo => {
                const option = document.createElement('option');
                option.value = promo.rate;
                option.textContent = promo.name;
                bankRatesSelect.appendChild(option);
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏≠‡∏á
            const otherOption = document.createElement('option');
            otherOption.value = "-1";
            otherOption.textContent = "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)";
            bankRatesSelect.appendChild(otherOption);

            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á" ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á input field
            bankRatesSelect.addEventListener('change', () => {
                const existingCustomRate = document.getElementById('customRate');
                if (existingCustomRate) {
                    existingCustomRate.parentElement.remove();
                }

                if (bankRatesSelect.value === "-1") {
                    const div = document.createElement('div');
                    div.className = "mt-2";
                    const input = document.createElement('input');
                    input.type = "number";
                    input.id = "customRate";
                    input.className = "form-input";
                    input.placeholder = "‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%) ‡πÄ‡∏ä‡πà‡∏ô 3.75";
                    div.appendChild(input);
                    bankRatesSelect.parentElement.appendChild(div);
                }
            });
        }

        /**
         * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ (‡∏™‡∏π‡∏ï‡∏£ MRTA)
         */
        function calculateMortgage(principal, annualRate, years) {
            const monthlyRate = (annualRate / 100) / 12;
            const numberOfPayments = years * 12;

            if (monthlyRate === 0) {
                return principal / numberOfPayments;
            }

            const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) /
                (Math.pow(1 + monthlyRate, numberOfPayments) - 1);

            return payment;
        }

        /**
         * ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô Format ‡πÄ‡∏á‡∏¥‡∏ô
         */
        function formatCurrency(num) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 0, // ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó
                maximumFractionDigits: 0
            }).format(num);
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        /**
         * ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
         */
        function clearError() {
            errorMessage.textContent = '';
            errorMessage.classList.add('hidden');
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏•‡∏±‡∏Å
         */
        function handleCalculate() {
            clearError();
            aiResult.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏ú‡∏• AI ‡πÄ‡∏Å‡πà‡∏≤
            aiBtn.classList.add('hidden'); // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° AI

            const income = parseFloat(incomeInput.value);
            const expenses = parseFloat(expensesInput.value) || 0;
            const loanAmount = parseFloat(loanAmountInput.value);
            const duration = parseFloat(durationInput.value);
            let interestRate = parseFloat(bankRatesSelect.value);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Custom Rate
            if (interestRate === -1) {
                const customRateInput = document.getElementById('customRate');
                if (!customRateInput || !customRateInput.value) {
                    showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢");
                    return;
                }
                interestRate = parseFloat(customRateInput.value);
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Input
            if (isNaN(income) || isNaN(loanAmount) || isNaN(duration) || isNaN(interestRate) || income <= 0 || loanAmount <= 0 || duration <= 0 || interestRate <= 0) {
                showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            if (income <= expenses) {
                showError("‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢");
                return;
            }

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î
            const monthlyPayment = calculateMortgage(loanAmount, interestRate, duration);

            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
            const netIncome = income - expenses;
            const remainingIncome = netIncome - monthlyPayment;

            // 3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (DSR - Debt Service Ratio)
            // ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏°‡∏±‡∏Å‡∏°‡∏≠‡∏á DSR ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 40%-60% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
            const dsr = (monthlyPayment / netIncome) * 100;
            let statusText = "";
            let statusColor = "";

            if (dsr <= 40) {
                statusText = "‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (‡∏î‡∏µ‡∏°‡∏≤‡∏Å)";
                statusColor = "bg-green-100 text-green-800";
            } else if (dsr <= 55) {
                statusText = "‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)";
                statusColor = "bg-yellow-100 text-yellow-800";
            } else if (dsr <= 70) {
                statusText = "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡∏∂‡∏á";
                statusColor = "bg-orange-100 text-orange-800";
            } else {
                statusText = "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á";
                statusColor = "bg-red-100 text-red-800";
            }

            // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            paymentResult.textContent = formatCurrency(monthlyPayment);
            netIncomeResult.textContent = formatCurrency(netIncome);
            statusResult.textContent = statusText;
            statusResult.className = `font-bold px-2 py-0.5 rounded-full text-sm ${statusColor}`;

            resultsDiv.classList.remove('hidden');
            aiBtn.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° AI

            // 5. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI
            lastCalculationData = {
                income,
                expenses,
                netIncome,
                loanAmount,
                duration,
                interestRate,
                monthlyPayment,
                remainingIncome,
                statusText
            };
        }

        /**
         * ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI
         */
        async function getAIAdvice() {
            if (!lastCalculationData) return;

            aiLoading.classList.remove('hidden');
            aiResult.classList.add('hidden');
            aiResult.textContent = "";
            aiBtn.disabled = true;

            const { income, expenses, netIncome, loanAmount, monthlyPayment, remainingIncome, statusText, interestRate, duration } = lastCalculationData;

            // System Prompt: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡πâ AI
            const systemPrompt = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á";
            
            // User Prompt: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            const userQuery = `
‡∏â‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Å‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡πâ‡∏≤‡∏ô ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô:
- ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${formatCurrency(income)}
- ‡∏†‡∏≤‡∏£‡∏∞‡∏ú‡πà‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô: ${formatCurrency(expenses)}
- ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢): ${formatCurrency(netIncome)}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏Å‡∏π‡πâ:
- ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ: ${formatCurrency(loanAmount)}
- ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢: ${interestRate.toFixed(2)}% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ
- ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô: ${duration} ‡∏õ‡∏µ
- ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ: ${formatCurrency(monthlyPayment)} ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ${statusText}
‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì): ${formatCurrency(remainingIncome)}

‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡πÑ‡∏´‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô 1-2 ‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ, ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô) ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô" ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
`;

            try {
                const responseText = await callGeminiAPI(systemPrompt, userQuery);
                aiResult.innerHTML = responseText.replace(/\n/g, '<br>'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                aiResult.classList.remove('hidden');
            } catch (error) {
                console.error("Gemini API Error:", error);
                aiResult.innerHTML = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                aiResult.classList.remove('hidden');
            } finally {
                aiLoading.classList.add('hidden');
                aiBtn.disabled = false;
            }
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Gemini API (gemini-2.5-flash-preview-09-2025) ‡∏û‡∏£‡πâ‡∏≠‡∏° Exponential Backoff
         */
        async function callGeminiAPI(systemPrompt, userQuery, retries = 3, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // ‡∏ñ‡πâ‡∏≤ Server Error (‡πÄ‡∏ä‡πà‡∏ô 500, 503) ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    if (response.status >= 500 && retries > 0) {
                        throw new Error(`Server error ${response.status}, retrying...`);
                    }
                    // ‡∏ñ‡πâ‡∏≤ Client Error (‡πÄ‡∏ä‡πà‡∏ô 400, 404) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return text;
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà API ‡∏ï‡∏≠‡∏ö 200 ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ content (‡πÄ‡∏ä‡πà‡∏ô Safety settings)
                    return "AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞";
                }

            } catch (error) {
                if (retries > 0) {
                    // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Exponential Backoff)
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(systemPrompt, userQuery, retries - 1, delay * 2);
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏±‡∏á‡∏û‡∏•‡∏≤‡∏î
                    throw error;
                }
            }
        }


        // --- Event Listeners ---

        // 1. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown
        document.addEventListener('DOMContentLoaded', populateBankRates);

        // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"
        calculateBtn.addEventListener('click', handleCalculate);

        // 3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ AI"
        aiBtn.addEventListener('click', getAIAdvice);

    </script>
</body>

</html>

